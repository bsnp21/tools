<!DOCTYPE html>
<HTML manifest___xxx="BiblePad-2015.appcache">

<HEAD>
    <TITLE>ci</TITLE>
    <META http-equiv="Content-Type" content="text/html;" charset="UTF-8">
    <META name="viewport" content="width=device-witdh, initial-scale=1, maximum-scale=1, user-scale=0">

    <script language="javascript" src="../js/jquery-2_1_3.min.js"></script>

    <script language="javascript" src="../js/Pinyin_7kSimplified.js">
    </script>


    <script language="javascript" src="../js/Simplified_Traditionals.js">
    </script>


    <style type="text/css">
        #txtar {
            position: fixed;
            top: 0px;
            left: 250px;
            height: 200px;
            width: 300px;
            border-color: #eeaaee;
            font-size: 24px;

        }

        #inp {
            position: fixed;
            top: 210px;
            left: 250Px;
            background-color: #eeee00;
            font-size: 24px;
            border: none;
        }

        #mainmenu {
            position: fixed;
            width: 300px;
            top: 250px;
            left: 250px;
        }

        .pinyin {
            background-color: #dddd99;

        }

        .hilite {
            background-color: #ff0000;
        }

        .hilite_row {
            background-color: #eeee00;
        }

        .TxtareaFocused {
            background-color: lightyellow;
        }
    </style>

    <script language="javascript">
        var g_inpstr = "", g_scrollIntoViewDir = true;//up, false:bottom.
        $(document).ready(function () {

            var pyarr = makeTable();
            function GetFirstAvailablePinyin(py, pinyinArr) {
                for (var i = 1; i <= 5; i++) {
                    var pyid = py + i;
                    if (pinyinArr.indexOf(pyid) >= 0) {
                        return pyid;
                    }
                }
                return "";//alert("fatal error! no such pinyin:"+py);
            }
            $("#listallp").click(function () {
                var s = "\n", syllables = {};
                $.each(pyarr, function (i, k) {
                    s += "" + i + ":" + k + "\n";

                    syl = k.substr(0, k.length - 1);
                    syllables[syl] = 0;
                });
                s += "\n====\n" + JSON.stringify(syllables, null, 4);
                s += "tot=" + Object.keys(syllables).length;
                $("#txtar").val($("#txtar").val() + s);
            });

            $("#txtar").on("focus", function () {
                $(this).addClass("TxtareaFocused")
            }).on("blur", function () {
                $(this).removeClass("TxtareaFocused")
            })

            $("body").keyup(function (e) {
                if ($(".TxtareaFocused").size() > 0) {
                    return;
                }
                var c = (e.which);
                console.log(c);
                $("#dbg_keydwn").text(c)

                if ((c >= 65 && c <= 90) || 8 === c) {//letter or back
                    if (8 === c) {//backspace
                        g_inpstr = g_inpstr.substr(0, g_inpstr.length - 1);
                    }
                    else {
                        g_inpstr += String.fromCharCode(c);
                    }
                    g_inpstr = g_inpstr.toLowerCase();
                    $("#inp").val(g_inpstr);
                    var sid = GetFirstAvailablePinyin(g_inpstr, pyarr);
                    $("#" + sid).each(function () {
                        $(this)[0].scrollIntoView();
                        $(".hilite").removeClass("hilite");
                        $(this).parentsUntil("tbody").next().find(".zi:eq(0)").addClass("hilite");
                    });
                }
                else {
                    switch (c) {
                        case 37://left arrow
                        case 219:// move to left "{".
                            var hi = $(".hilite");
                            var prev = $(hi).prev(".zi");
                            if ($(prev).length > 0) {
                                $(prev).addClass("hilite");
                                $(hi).removeClass("hilite");
                            }
                            return false;

                        case 39://right arrow.
                        case 221: // move to right "}".
                            var hi = $(".hilite");
                            var next = $(hi).next(".zi");
                            if (next.length > 0) {
                                $(next).addClass("hilite");
                                $(hi).removeClass("hilite");
                            }
                            return false;

                        case 40://arrow down.
                        case 186://move donw [;]
                            {
                                var hi = $(".hilite");
                                if (!hi.length) return;
                                var nxr = $(hi).parentsUntil("tbody").nextUntil(".rowzi");//exclusively.
                                if (nxr.length > 0) {
                                    nxr = $(nxr).last().next();
                                } else {
                                    nxr = $(hi).parentsUntil("tbody").next();
                                }
                                $(".zi").removeClass("hilite");
                                $(nxr).find(".zi:eq(0)").addClass("hilite");
                                g_scrollIntoViewDir = true;
                                $(".hilite_row").removeClass("hilite_row")
                                $(nxr).addClass("hilite_row")
                            }
                            return false;

                        case 38://arrow up.
                        case 222://move up [']
                            {
                                var hi = $(".hilite");
                                if (!hi.length) return;
                                var nxr = $(hi).parentsUntil("tbody").prevUntil(".rowzi");//exclusively.

                                if (nxr.length > 0) {
                                    nxr = $(nxr).last().prev();//must take the last one.
                                    console.log("nx.length>0")
                                } else {
                                    nxr = $(hi).parentsUntil("tbody").prev();
                                    console.log("nx.length===0")
                                }
                                $(".zi").removeClass("hilite");
                                $(".hilite_row").removeClass("hilite_row")
                                $(nxr).addClass("hilite_row")
                                $(nxr).find(".zi:eq(0)").addClass("hilite");//[0].scrollIntoView(false);  
                                g_scrollIntoViewDir = false;
                            }
                            return false;

                        case 16://shift to show
                            $(".hilite").each(function () {
                                $(this)[0].scrollIntoView(g_scrollIntoViewDir);
                            })
                            return;

                        case 32://space to clear
                            g_inpstr = "";
                            $("#inp").val("");
                            return;

                        case 13://enter to add.
                            $(".hilite").each(function () {
                                var t = $(this).text();
                                $("#txtar").val($("#txtar").val() + t);
                                g_inpstr = "";
                                $("#inp").val("");
                            })
                            return;
                    };////switch
                }//if(c)
            });

            $(".zi").click(function (e) {
                var zi = $(this).text();

                $("#txtar").trigger("keyup", function (e) {
                    console.log(zi, e.which)

                })

                var va = $("#txtar").val();
                $("#txtar").val(va + zi);
                g_inpstr = "";
                //console.log($(this).text());
                $(".hilite").removeClass("hilite")
                $(this).addClass("hilite")
            });

        });

        function makeTable() {
            var tab = "<table border='1' note='pinyin_hanzi_list_Table'>";

            var pinyinArr = [];
            $.each(Pinyin7kzi, function (k, chary) {
                pinyinArr.push(k);
                tab += "<tr><td colspan='10' class='pinyin' id='" + k + "'>" + k + "</td></tr>"

                var rowstart = 0;
                for (var i = 0; i < chary.length; i++) {
                    //if (chary[i] === "鵀") continue;//does not support latex gkai.
                    if (rowstart === 0) {
                        tab += "<tr class='rowzi'>";
                    }
                    tab += `<td class='zi'>${chary[i]}</td>`;
                    rowstart = (1 + i) % 10
                    if (rowstart === 0) {
                        tab += "</tr>";
                    }
                };//for

            });
            $("#out").html(tab);
            return pinyinArr;
        }


    </script>
</HEAD>

<BODY>

    <textarea id="txtar"></textarea>
    <input id="inp" readonly='1'></input>

    <div id="mainmenu">
        <a href="ChineseSimplifyer.html" target="_blank">ChineseSimplifyer</a><br>
        ← move to left. <br>→ move to right. <br>↓ move to down. <br>↑ move to up.<br>[shift]
        scrollintoview<br>

        <button id='listallp'>allpinyin</button>
        <a id="dbg_keydwn"></a>
    </div>
    <div id="out">-</div>
</BODY>

</HTML>